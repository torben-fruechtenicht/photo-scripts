#! /usr/bin/env bash

set -e
shopt -s nocasematch

declare -r COLLECTOR_CMD=$(dirname "$0")/lib/collect_associated_files.sh

declare -r KEYWORDS=$1
if [[ -z $KEYWORDS ]]; then
	echo "No keywords" >&2
	exit 1
elif [[ -f $KEYWORDS || -d $KEYWORDS ]]; then
	echo "Keywords parameter seems to be a file or directory - actual keywords parameter is missing?"
	exit 1
fi

shift 1
declare -r FILES=$@

set -u

quote_if_spaces_exist() {
	local -r keyword=$1
	if [[ $keyword =~ .+[[:space:]].+ ]]; then
		echo "\"$keyword\""
	else
		echo $keyword
	fi	
}

set_iptc_in_sidecar() {
	local -r sidecar_file=$1
	local new_keywords=

	local -r OLD_IFS=$IFS
	IFS=";"

	local old_keywords=$(sed -rn '/\[IPTC\]/,/^$/ s/Keywords=(.+);+$/\1/p' "$sidecar_file")
	for old_keyword in $old_keywords; do 
		if ! [[ $KEYWORDS =~ .*$old_keyword.* ]]; then
			new_keywords="$new_keywords;$old_keyword"
		fi		
	done

	for new_keyword in $KEYWORDS; do
		new_keywords="$new_keywords$(quote_if_spaces_exist "$new_keyword");"
	done

	IFS=$OLD_IFS

	if [[ -n $new_keywords ]]; then
		sed -i '/\[IPTC\]/,/^$/ s/Keywords=.*;$/Keywords='"$new_keywords"'/' "$sidecar_file"
	fi
}

set_iptc_in_jpeg() {
	local -r jpeg_file=$1
	local -r old_keywords=$(exiv2 -PIt -K Iptc.Application2.Keywords $jpeg_file 2> /dev/null)

	local -r OLD_IFS=$IFS
	IFS=";"

	for new_keyword in $KEYWORDS; do
		if [[ "$old_keywords" =~ .*$new_keyword.* ]]; then
			continue
		fi

		if [[ $new_keyword =~ .+[[:space:]].+ ]]; then
			new_keyword="\"$new_keyword\""
		fi
		exiv2 -M "add Iptc.Application2.Keywords $new_keyword" "$jpeg_file" 2> /dev/null
	done

	IFS=$OLD_IFS
}


"$COLLECTOR_CMD" $FILES | while read -r file; do

	if [[ $file =~ .*\.pp[23]$ ]]; then

		if ! [[ -w $file ]]; then
			chmod u+w "$file"
			declare restore_write_protection=
		fi

		if ! grep "^[IPTC]$" "$file"; then
			echo -e "\n[IPTC]\nKeywords=;\n" >> $file			
		fi

		set_iptc_in_sidecar "$file"

		test -v restore_write_protection && chmod u-w "$file" && unset restore_write_protection

	elif [[ $file =~ .*/converted/.*\.jpg$ ]]; then

		if ! [[ -w $file ]]; then
			test -v SIMULATE || chmod u+w "$file"
			declare restore_write_protection=
		fi

		set_iptc_in_jpeg "$file"

		test -v restore_write_protection && chmod u-w "$file" && unset restore_write_protection

	fi
	
done