#! /usr/bin/env bash

set -eu

source "$(dirname "$0")/builder_lib.sh"

declare -r camera=$1

while read import_item; do  
    # filename pattern: <TITLE_INCL_UNDERSCORES>_<DAY>_<TIMEOFDAY>-<NUMBER>.<EXT>

    source=$(source_from_import_item "$import_item")
    source_file=$(basename "$source")
    source_dir=$(dirname "$source")

    # FIXME TBD there is probably some unneeded complexity in the lines below (still there from the first iterations of this step)

    file_without_ext=${source_file%.*}
    ext=${source_file#*.}

    front_part=$(cut -d'-' -f1 <<<$file_without_ext)
    number=$(cut -d'-' -f2 <<<$file_without_ext)

    title=$(sed -r 's/([a-z_]+)_[0-9]+_[0-9]+(-[0-9])?/\1/' <<<$front_part | tr _ -)
    day=$(sed -r 's/[a-z_]+_([0-9]+)_[0-9]+(-[0-9])?/\1/' <<<$front_part)
    time=$(sed -r 's/[a-z_]+_[0-9]+_([0-9]+)(-[0-9])?/\1/' <<<$front_part)

    target_filename="${title}_${day}_${time}_${camera}_${number}.${ext}"

    if [[ $source_dir =~ .+/converted ]]; then
        echo_item_added_targetpath "$import_item" "converted/$target_filename"
    else 
        echo_item_added_targetpath "$import_item" "$target_filename"
    fi
    
done < /dev/stdin
